# Tello Scratch ドローンショー・コントローラー

Scratch 3プロジェクトファイル（.sb3）からTelloドローンのショーを実行するPythonアプリケーションです。

## 機能

- Scratch 3プロジェクトファイル（.sb3）の読み込みと解析
- 複数のTelloドローンを同時に制御
- タイムライン表示とリアルタイムハイライト
- 音楽ファイル（MP3/WAV/OGG）の再生（ショー実行と同期）
- ドローン設定の保存と読み込み
- 通信ログの表示
- 緊急停止機能

## 必要なもの

### ハードウェア

- Telloドローン（1台以上）
- Wi-Fi接続可能なPC

### ソフトウェア

- Python 3.7以上
- 以下のPythonパッケージ:
  - tkinter（通常Pythonに標準で含まれています）
  - pygame（音楽再生用）

## インストール

1. このリポジトリをクローンまたはダウンロード

```bash
git clone https://github.com/yourusername/Better-Tello-GUI.git
cd Better-Tello-GUI
```

2. pygameをインストール

```bash
pip install pygame
```

## 使い方

### 1. アプリケーションの起動

```bash
python src/main.py
```

### 2. ドローン設定

① **ドローンIPアドレス設定**セクションで:
- 使用するドローンのIPアドレスを入力
- 「＋ 追加」ボタンで追加のドローンを設定
- 「⚙️ 設定を保存」ボタンで設定を保存（`tello_config.json`に保存されます）

### 3. Scratchファイルの読み込みと解析

② **プロジェクト選択**セクションで:
- 「📂 Scratchファイルを開く」をクリック
- .sb3ファイルを選択
- 「🔄 タイムラインを解析」をクリックしてScratchプロジェクトを解析

### 4. 音楽設定（オプション）

音楽を追加する方法は2つあります：

**方法1: クイック選択（単一ファイル）**
- 「🎶 クイック選択」をクリック
- MP3、WAV、OGG、FLACファイルを選択

**方法2: メドレー管理（複数ファイル）**
- 「🎼 メドレー管理」をクリック
- 複数の音楽ファイルを追加・並び替え
- 曲間のインターバル（0〜10秒）を設定
- 各曲の事前プレビューが可能

### 5. タイムラインの確認

③ **タイムラインビューアー**:
- 「🎬 タイムラインを表示」をクリック
- 動画編集ソフト風のUIで音楽とドローンの動きを視覚的に確認
- ズームイン/アウト機能で詳細表示

### 6. ドローンへの接続とショー実行

③ **ショー実行**セクションで:
1. 「📡 ドローンに接続」をクリックしてドローンとの接続を確立
2. 接続成功後、「▶️ ショーを開始」をクリックしてショーを実行
3. 音楽はドローンの離陸完了（約3秒後）に自動的に再生されます
4. 緊急時は「⏹️ 緊急停止」をクリック

## Scratchプロジェクトの作成

Scratch 3でドローンショーのプログラムを作成する際の注意点:

### 基本ルール

1. 各スプライトは1台のドローンに対応します
2. スプライト名はドローン設定の名前と一致させてください（例: `Tello_A`、`Tello_B`）
3. 各スプライトに「緑の旗が押されたとき」ブロックを配置してください

### 座標変換

- Scratchの座標 → Telloの移動距離
  - X座標: 横方向の移動（cm）
  - Y座標: 前後の移動（cm）
  - 大きさ: 高度（%を cmに変換）

### 対応しているScratchブロック

- **移動**: 座標の変化がTelloの移動コマンドに変換されます
- **待機**: 「○秒待つ」ブロックは待機時間として処理されます

### サンプルプロジェクト

```
スプライト: Tello_A
┌─────────────────────────┐
│ 緑の旗が押されたとき      │
│ x座標を 0 y座標を 0 にする│
│ 大きさを 100 % にする      │
│ 1 秒待つ                  │
│ x座標を 100 y座標を 0 にする│
│ 1 秒待つ                  │
│ x座標を 100 y座標を 100 にする│
└─────────────────────────┘
```

## プロジェクト構造

```
Better-Tello-GUI/
├── src/
│   ├── main.py                      # エントリーポイント
│   ├── config.py                    # 設定と定数
│   ├── tello_controller.py          # ドローン通信制御
│   ├── scratch_parser.py            # Scratchプロジェクト解析（変数/カスタムブロック対応）
│   ├── show_runner.py               # ショー実行ロジック（接続/実行管理）
│   ├── music_player.py              # 音楽再生機能（メドレー/インターバル対応）
│   └── gui/
│       ├── main_window.py           # メインGUIウィンドウ
│       ├── music_manager_window.py  # 音楽管理ウィンドウ（メドレー設定）
│       └── timeline_viewer_window.py # タイムラインビューアー（視覚的表示）
├── tello_config.json                # ドローン設定ファイル（自動生成）
├── LICENSE
└── README.md
```

## 音楽再生機能について

### 対応ファイル形式

- MP3 (`.mp3`)
- WAV (`.wav`)
- OGG (`.ogg`)
- FLAC (`.flac`)

### タイミング

- 音楽はショー開始ボタンを押した後、ドローンの離陸完了（約3秒後）に再生されます
- 緊急停止またはショー完了時に音楽は自動的に停止します

### pygameが利用できない場合

pygameがインストールされていない場合、音楽再生機能は使用できませんが、ドローンショーは通常通り実行できます。

## トラブルシューティング

### ドローンに接続できない

1. ドローンの電源が入っているか確認
2. PCがドローンのWi-Fiに接続されているか確認
3. IPアドレスが正しいか確認（通常は`192.168.10.1`）

### 音楽が再生されない

1. pygameがインストールされているか確認:
   ```bash
   pip show pygame
   ```
2. 音楽ファイルの形式が対応しているか確認（MP3/WAV/OGG/FLAC）
3. ログに表示されるエラーメッセージを確認

### Scratchファイルが解析できない

1. ファイルが.sb3形式であることを確認
2. スプライトに「緑の旗が押されたとき」ブロックがあるか確認
3. スプライト名がドローン設定の名前と一致しているか確認

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は[LICENSE](LICENSE)ファイルを参照してください。

## 注意事項

- ドローンの飛行は必ず安全な場所で行ってください
- 飛行前に周囲の安全を確認してください
- バッテリー残量に注意してください
- 初めて使用する際は、1台のドローンで動作確認することを推奨します

## 貢献

プルリクエストやイシューの報告を歓迎します！

## サポート

問題が発生した場合は、GitHubのIssuesセクションで報告してください。
